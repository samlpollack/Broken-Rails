<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Broken Rails Interactive Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script type="text/javascript" src='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' />

<script type="text/javascript" src="interactive_map_resources/filter_dict.js"></script>
<script type="text/javascript" src="interactive_map_resources/flot/excanvas.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="interactive_map_resources/flot/jquery.flot.js"></script>
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


<style>
  body { margin:0; padding:0; font:Helvetica;}
  #map { position:absolute; top:60px; bottom:0; width:80%; left:20%;}

  h2 {
    font-size: 20px;
    text-align: center;
  }
  .heading {
    font-size:40px;
    margin:0;
    font-weight:700;
    font: Helvetica; 
    position: absolute;
    top: 0;left: 0;
    height:60px;
    line-height:60px;
    width: 100%;
    background: #236085;
    color: #FFFFFF;
    vertical-align: middle;
    text-align:center;
  }

  #filter_adder {
    position: absolute;
    width: 20%;
    left:80%;
    color: #FFFFFF;
    vertical-align: middle;
    text-align:center;
    height: 60px;
    line-height: 60px;
    font: Helvetica; 
    font-size: 40px;
  }
  #filter_adder:hover{
    cursor:pointer;
  }
  #filter_adder:active{
    background:#236085;
    color:#D2D2D2;
  }
  #filter {
    width: 20%;
    background: #236085;
    color: #FFFFFF;
    height: 55px;
    position: absolute;
    top:5px;
    right:0%;
    font-size: 10px;
    border: 0px solid rgba(0,0,0,1); 
    padding-left: 3px;
  }
  .sidebyside {
    display: inline-block;
  }
  #closebutton {
    display: block;
    border: 1px solid rgba(0,0,0,.25);
    width: 10px;
    height: 10px;
    text-align: center;
    vertical-align: middle;
    font-size: 8px;
  }
  #closebutton:hover{
    cursor:pointer;
  }

  .side_panel {
    position: absolute;
    top:60px;left:0px;
    height: 100%;
    width: 20%;
    color: #FFFFFF;
    background: #236085;
    opacity: 1;

  }
  #filter_list {
    display: block;
    margin-left: 10px;
  }
  #filter_filler {
    display: block;
    text-align: center;
    margin-right: 10px;
  } 
  .filter_remover {
    margin-right:8px;
    border: 1px solid rgba(0,0,0,.5);
    vertical-align:middle;
    background:#808080;
  }
  .filter_remover:hover{
    cursor: pointer;
  }
  .stats {
    display: block;
    margin-left: 10px;
    margin-right: 10px;
  }
  .indent {
    margin-left: 10px;
  }
  #time-series {
    height:200px;
    background: #FFFFFF;
    color: #000000;
  }
  #popup {
    position: absolute;
    display: none;
    width: 20%;
    left:21%;
    background: #236085;
    color: #FFFFFF;
    opacity: .8;
  }
  .popup-stats {
    margin-left: 10px;
    margin-right: 10px;
  }
  #popup-time-series {
    height:200px;
    background: #FFFFFF;
    color: #000000;
  }
  #popup-close {
    position: absolute;
    display: none;
    background: #236085;
    color: #FFFFFF;
    height: 20px;
    width: 20%;
    left:21%;
    opacity: .8;
  }
  #popup-close-button {
    border: 1px solid rgba(0,0,0,.5); 
  }
  #popup-close-button:hover{
    cursor: pointer;
  }
  #stats-footer {
    position: absolute;
    bottom: 20px;
    margin-left: 20px;

  }

</style>
</head>
<body>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
  <!-- // <script src="stations.js"></script> -->

<div id='map'></div>
<div class='heading'>
  Broken Rails Interactive Map
</div>

<div class='side_panel'>
  <h2>FILTERS</h2>
  <div id='filter_list' class='filters'><div id='filter_filler'>- No Filters -</div></div>
  <div id='stats'>
    <div id='stats-title'><h2>STATS</h2></div>
    <div class='stats'>
      <div id='time-series'></div>
      <div id='defect-count'><br>Defect Count: <div id='defect-count-value' class='sidebyside'></div></div>
      <div id='mean-lifetime'>Mean Lifetime: <div id='mean-lifetime-value' class='sidebyside'></div></div>
      <div id='mean-tonnage'>Mean Tonnage: <div id='mean-tonnage-value' class='sidebyside'></div></div>
      <div id='common-defects'><br>Defect Types: 
        <div id='defect1' class='indent'></div>
        <div id='defect2' class='indent'></div>
        <div id='defect3' class='indent'></div>
      </div>
      <div id='common-track-types'><br>Track Types: 
        <div id='track1' class='indent'></div>
        <div id='track2' class='indent'></div>
        <div id='track3' class='indent'></div>
      </div>
      <div id='common-dvcds'><br>DvCd Types: 
        <div id='dvcd1' class='indent'></div>
        <div id='dvcd2' class='indent'></div>
        <div id='dvcd3' class='indent'></div>
      </div>
      <div id='rail-types'><br>Rail Types:
        <div id='cwr' class='indent'></div>
        <div id='bolted' class='indent'></div>
      </div>
    </div>
  </div>
  <div id='stats-footer'>Data until July 3rd, 2015</div>
</div>
<div id='popup'>
  <div id='popup-title'></div>
  <div class='popup-stats'>
    <div id='popup-time-series'></div>
    <div id='popup-defect-count'><br>Defect Count: <div id='popup-defect-count-value' class='sidebyside'></div></div>
    <div id='popup-mean-lifetime'>Mean Lifetime: <div id='popup-mean-lifetime-value' class='sidebyside'></div></div>
    <div id='popup-mean-tonnage'>Mean Tonnage: <div id='popup-mean-tonnage-value' class='sidebyside'></div></div>
    <div id='popup-common-defects'><br>Defect Types: 
      <div id='popup-defect1' class='indent'></div>
      <div id='popup-defect2' class='indent'></div>
      <div id='popup-defect3' class='indent'></div>
    </div>
    <div id='popup-common-track-types'><br>Track Types: 
      <div id='popup-track1' class='indent'></div>
      <div id='popup-track2' class='indent'></div>
      <div id='popup-track3' class='indent'></div>
    </div>
    <div id='popup-common-dvcds'><br>DvCd Types: 
      <div id='popup-dvcd1' class='indent'></div>
      <div id='popup-dvcd2' class='indent'></div>
      <div id='popup-dvcd3' class='indent'></div>
    </div>
    <div id='popup-rail-types'><br>Rail Types:
      <div id='popup-cwr' class='indent'></div>
      <div id='popup-bolted' class='indent'></div>
    </div>
  </div>
</div>

<div id='popup-close'><div id='popup-close-button' class='sidebyside' type='button' onclick='popup_close();'>close</div></div>


<div id='filter_adder' type='button' onclick='addFilter()'>
  + filter
</div>
<div id='filter' style='display:none;'>
  <div id='closebutton' type='button' onclick='closeBox()'>X</div>
  <div>Select One
    <select id='select-list' style='background:#236085;color:#FFFFFF;'>
      <option value='0'>Priority</option>
      <option value='1'>DvCd</option>
      <option value='2'>TrackType</option>
      <option value='3'>Div</option>
      <option value='4'>LineName</option>
      <option value='5'>Line</option>
      <option value='6'>Track</option>
      <option value='7'>DefectType</option>
      <option value='8'>PlateType</option>
      <option value='9'>RailWeight</option>
      <option value='10'>RailType</option>
      <option value='11'>Manufacturer</option>
      <option value='12'>FoundDate</option>
      <option value='13'>ProducedDate</option>
      <option value='14'>Million Gross Tons</option>
      <option value='15'>RailAge</option>
      <option value='16'>latitude</option>
      <option value='17'>longitude</option>
    </select>
  </div>
  <div id='categorical_options' style='display:none;background:#236085;color:#FFFFFF;'>
    <div class='sidebyside'> = </div>
    <div id='categorical_values' class='sidebyside' style='background:#236085;color:#FFFFFF;'></div>
  </div>
  <div id='numerical_options' style='display:none;'>
    <div id='relation' class='sidebyside'>
      <select id='select-relation' style='background:#236085;color:#FFFFFF;'>
        <option value='0'>=</option>
        <option value='1'>></option>
        <option value='2'><</option>
      </select>
    </div>
    <div id='numerical_value' class='sidebyside'>
      <form><input type='number' style='background:#236085;color:#FFFFFF;' id='numerical_input'><input type='button' style='background:#236085;color:#FFFFFF;' value='Add Filter' onclick='executeFilter()'></form>
    </div>
  </div>
  <div id='date_options' style='display:none;'>
    <div id='date_relation' class='sidebyside'>
      <select id='select_date_relation' style='background:#236085;color:#FFFFFF;'>
        <option value='0'>=</option>
        <option value='1'>></option>
        <option value='2'><</option>
      </select>
    </div>
    <div id='date_value' class='sidebyside'>
      <form><input type='date' style='background:#236085;color:#FFFFFF;' id='date_input'><input type='button' style='background:#236085;color:#FFFFFF;' value='Add Filter' onclick='executeFilter()'></form>
    </div>
  </div>
</div>



<script>

$('.side_panel').css('height','-=60px');

var categorical_filters = ['Priority', 'DvCd', 'TrackType', 'Div', 'LineName', 'Line', 'Track', 'DefectType', 'PlateType', 'RailWeight', 'RailType', 'Manufacturer'];
var numerical_filters = ['Million Gross Tons', 'RailAge', 'latitude', 'longitude'];
var date_filters = ['FoundDate', 'ProducedDate']
var all_filters = ['Priority', 'DvCd', 'TrackType', 'Div', 'LineName', 'Line', 'Track', 'DefectType', 'PlateType', 'RailWeight', 'RailType', 'Manufacturer', 'FoundDate', 'ProducedDate', 'Million Gross Tons', 'RailAge', 'latitude', 'longitude'];
var selection = '';
var added_filter = '';
var relations = ['=','>','<'];
var added_relation = '';
var values = [];
var added_value = '';
var current_filters = [];
var dvcd_dict = {'100M':'Tangent','200M':'Unguarded Curve','300M':'Guarded Curve','400M':'Switches/Turnouts'};

// var categorical_options = d3.select('#categorical_options');

d3.select('#select-list').on("change", function(){
  selection = all_filters[eval(d3.select(this).property('value'))];
  added_filter = selection;
  if (categorical_filters.indexOf(selection) >= 0) {
    values = filter_dict[selection];
    document.getElementById('numerical_options').style.display = 'none';
    document.getElementById('date_options').style.display = 'none';
    document.getElementById('categorical_options').style.display = 'block';
    var innerhtml = '<div><select id="select-categorical" style="background:#236085;color:#FFFFFF;">';
    var n = 0;
    for (value in values) {
      innerhtml += '<option value="'+n+'">'+values[n]+'</option>';
      n += 1;
    }
    innerhtml += '</select><input type="button" style="background:#236085;color:#FFFFFF;" value="Add Filter" onclick="executeFilter()"></form></div>';
    document.getElementById('categorical_values').innerHTML = innerhtml;
  } else if(numerical_filters.indexOf(selection) >= 0) {
    document.getElementById('categorical_options').style.display = 'none';
    document.getElementById('date_options').style.display = 'none';
    document.getElementById('numerical_options').style.display = 'block';
  } else {
    document.getElementById('categorical_options').style.display = 'none';
    document.getElementById('numerical_options').style.display = 'none';
    document.getElementById('date_options').style.display = 'block';
  }
})

L.mapbox.accessToken = 'pk.eyJ1Ijoic2FtbHBvbGxhY2siLCJhIjoiNmFkOWY2MzEyY2M1MWNkMTcxZTViNGRjNmE5YmU0NDUifQ.1GsvK3aSrXn9HseAu76Y1w';
var map = L.mapbox.map('map', 'mapbox.streets', {zoomControl: false})
  .setView([40.73, -73.95],12);
new L.Control.Zoom({position:'topright'}).addTo(map);


var defects = L.mapbox.featureLayer();
defects.loadURL('https://raw.githubusercontent.com/samlpollack/Broken-Rails/master/interactive_map_resources/map_data.geojson?token=ALInTFqo3vjIfl3wV3gRWu15fsguHnyuks5WMRnrwA%3D%3D');

/*heat map*/ /*cluster map*/
var heat = L.heatLayer([]).addTo(map);
var clusterGroup = new L.MarkerClusterGroup({
  spiderfyOnMaxZoom: false
});

defects.on('ready', function() {
  filterMap();
});


map.on('zoomend', function() {
  console.log('Zoom ' + map.getZoom())
  if (map.getZoom() > 13) {
    if (map.hasLayer(heat)) {
      console.log('heat -> cluster')
      map.removeLayer(heat);
      map.addLayer(clusterGroup);
    } 
  } else {
    if (map.hasLayer(clusterGroup)) {
      console.log('cluster -> heat')
      map.removeLayer(clusterGroup);
      map.addLayer(heat);
    }
  }
});


clusterGroup.on('clusterclick', function(a) {
  if (map.getZoom() == 19) {
    var layers = a.layer.getAllChildMarkers();
    document.getElementById('popup').style.display = 'block';

    var station_name = '';
    var division = '';
    var timeline = {2005:0,2006:0,2007:0,2008:0,2009:0,2010:0,2011:0,2012:0,2013:0,2014:0,2015:0};
    var defect_count = 0;
    var mean_lifetime = 0;
    var lifetime_count = 0;
    var mean_tonnage = 0;
    var tonnage_count = 0;
    var defect_types = {};
    var track_types = {};
    var dvcd_types = {};
    var track_count = 0;
    var dvcd_count = 0;
    var cwr = 0;
    var bolted = 0;


    for (i in layers) {
      var layer = layers[i];
      var props = layer.feature.properties;
      station_name = props['StationName'];
      division = props['Div'];

      var foundDate = layer.feature.properties.FoundDate;
      var index = foundDate.lastIndexOf('/');
      var year = parseInt(foundDate.slice(index+1,foundDate.length));
      if (year < 2000) {
        year += 2000;
      }
      timeline[year] += 1;

      defect_count += 1;

      var lifetime = layer.feature.properties.RailAge;
      
      if (lifetime != '') {
        lifetime = parseInt(lifetime);
        mean_lifetime += lifetime;
        lifetime_count += 1;
      }

      var tonnage = layer.feature.properties['Million Gross Tons'];
      
      if (tonnage != '') {
        tonnage = parseInt(tonnage);
        mean_tonnage += tonnage;
        tonnage_count += 1;
      }

      var defect_type = layer.feature.properties.DefectType;
      if (defect_type in defect_types) {
        defect_types[defect_type] += 1;
      } else {
        defect_types[defect_type] = 1;
      }

      var track_type = layer.feature.properties.TrackType;
      if (track_type != '') {
        track_count += 1;
        if (track_type in track_types) {
          track_types[track_type] += 1;
        } else {
          track_types[track_type] = 1;
        }
      }
      

      var dvcd_type = layer.feature.properties.DvCd;
      if (dvcd_type != '') {
        dvcd_count += 1;
        if (dvcd_type in dvcd_types) {
          dvcd_types[dvcd_type] += 1;
        } else {
          dvcd_types[dvcd_type] = 1;
        }
      }

      var rail_type = props['RailType'];
      if (rail_type == 'CWR') {
        cwr += 1;
      } else if (rail_type == 'BOLTED') {
        bolted += 1;
      }
    }



    document.getElementById('popup-title').innerHTML = '<h2>'+station_name+', '+division+'</h2>';
    mean_lifetime = Math.round(100*mean_lifetime/(365*lifetime_count))/100;
    document.getElementById('popup-mean-lifetime-value').innerHTML = mean_lifetime + ' Years';
    mean_tonnage = Math.round(100*mean_tonnage/tonnage_count)/100;
    document.getElementById('popup-mean-tonnage-value').innerHTML = mean_tonnage + ' Million Gross Tons';
    document.getElementById('popup-defect-count-value').innerHTML = defect_count + ' Defects';

    var first_defect = [0,''];
    var second_defect = [0,''];
    var third_defect = [0,''];
    for (defect in defect_types) {
      var count = defect_types[defect];
      if (count > first_defect[0]) {
        third_defect = second_defect;
        second_defect = first_defect;
        first_defect = [count,defect];
      } else if (count > second_defect[0]) {
        third_defect = second_defect;
        second_defect = [count,defect];
      } else if (count > third_defect[0]) {
        third_defect = [count,defect];
      }
    }
    first_defect[0] = Math.round(first_defect[0]*100/defect_count);
    second_defect[0] = Math.round(second_defect[0]*100/defect_count);
    third_defect[0] = Math.round(third_defect[0]*100/defect_count);

    document.getElementById('popup-defect1').innerHTML = first_defect[1] + ' ' + first_defect[0] + '%';
    document.getElementById('popup-defect2').innerHTML = second_defect[1] + ' ' + second_defect[0] +'%';
    document.getElementById('popup-defect3').innerHTML = third_defect[1] + ' ' + third_defect[0] + '%';

    var first_track = [0,''];
    var second_track = [0,''];
    var third_track = [0,''];
    for (track in track_types) {
      var count = track_types[track];
      if (count > first_track[0]) {
        third_track = second_track;
        second_track = first_track;
        first_track = [count,track];
      } else if (count > second_track[0]) {
        third_track = second_track;
        second_track = [count,track];
      } else if (count > third_track[0]) {
        third_track = [count,track];
      }
    }
    first_track[0] = Math.round(first_track[0]*100/track_count);
    second_track[0] = Math.round(second_track[0]*100/track_count);
    third_track[0] = Math.round(third_track[0]*100/track_count);

    document.getElementById('popup-track1').innerHTML = first_track[1] + ' ' + first_track[0] + '%';
    document.getElementById('popup-track2').innerHTML = second_track[1] + ' ' + second_track[0] +'%';
    document.getElementById('popup-track3').innerHTML = third_track[1] + ' ' + third_track[0] + '%';

    var first_dvcd = [0,''];
    var second_dvcd = [0,''];
    var third_dvcd = [0,''];
    for (dvcd in dvcd_types) {
      var count = dvcd_types[dvcd];
      if (count > first_dvcd[0]) {
        third_dvcd = second_dvcd;
        second_dvcd = first_dvcd;
        first_dvcd = [count,dvcd];
      } else if (count > second_dvcd[0]) {
        third_dvcd = second_dvcd;
        second_dvcd = [count,dvcd];
      } else if (count > third_dvcd[0]) {
        third_dvcd = [count,dvcd];
      }
    }
    first_dvcd[0] = Math.round(first_dvcd[0]*100/dvcd_count);
    second_dvcd[0] = Math.round(second_dvcd[0]*100/dvcd_count);
    third_dvcd[0] = Math.round(third_dvcd[0]*100/dvcd_count);

    document.getElementById('popup-dvcd1').innerHTML = dvcd_dict[first_dvcd[1]] + ' ' + first_dvcd[0] + '%';
    document.getElementById('popup-dvcd2').innerHTML = dvcd_dict[second_dvcd[1]] + ' ' + second_dvcd[0] +'%';
    document.getElementById('popup-dvcd3').innerHTML = dvcd_dict[third_dvcd[1]] + ' ' + third_dvcd[0] + '%';


    var plate_count = cwr + bolted;
    cwr = Math.round(100*cwr/plate_count);
    bolted = Math.round(100*bolted/plate_count);
    document.getElementById('popup-cwr').innerHTML = 'CWR ' + cwr + '%';
    document.getElementById('popup-bolted').innerHTML = 'BOLTED ' + bolted + '%';

    var data = [];
    
    for (i in timeline){
      data.push([parseInt(i),timeline[i]]);
    }
    var options = {
      series: {
          lines: { show: true },
          points: { show: true }
      }
    };
    $(document).ready(function() {
      $.plot($('#popup-time-series'), [data],options);
    });

    document.getElementById('popup').style.top = document.getElementById('filter_list').getBoundingClientRect().bottom + 'px';
    document.getElementById('popup-close').style.top = String(parseInt(document.getElementById('filter_list').getBoundingClientRect().bottom) - 20) + 'px';
    document.getElementById('popup-close').style.display = 'block';
    console.log(document.getElementById('popup').getBoundingClientRect())
    console.log(document.getElementById('popup-close').getBoundingClientRect())
  }
});

function popup_close() {
  document.getElementById('popup').style.display = 'none';
  document.getElementById('popup-close').style.display = 'none';
}

function getPos(el) {
    // yay readability
    for (var lx=0, ly=0;
         el != null;
         lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
    return {x: lx,y: ly};
}

function addFilter() {
  document.getElementById('filter').style.display = 'block';
}
function closeBox() {
  document.getElementById('filter').style.display = 'none';
}
function executeFilter() {
  document.getElementById('categorical_options').style.display = 'none';
  document.getElementById('numerical_options').style.display = 'none';
  document.getElementById('date_options').style.display = 'none';
  closeBox();
  if (categorical_filters.indexOf(added_filter) >= 0) {
    added_relation = '=';
    added_value = String(values[eval(d3.select('#select-categorical').property('value'))]);
  } else if (numerical_filters.indexOf(added_filter) >= 0) {
    added_relation = relations[eval(d3.select('#select-relation').property('value'))];
    added_value = document.getElementById('numerical_input').value;
  } else if (date_filters.indexOf(added_filter) >= 0) {
    added_relation = relations[eval(d3.select('#select_date_relation').property('value'))];
    added_value = document.getElementById('date_input').value;
    console.log(added_value)
  }
  var filter_list = [added_filter,added_relation,added_value];
  var filter_string = added_filter+added_relation+added_value;
  current_filters.push(filter_list);
  console.log(current_filters)
  document.getElementById('filter_filler').style.display = 'none';
  document.getElementById('filter_list').innerHTML += '<div id = "'+filter_string+'"> <div class="filter_remover sidebyside" type="button" onclick="removeFilter('+"'"+filter_string+"'"+')">X</div>'+filter_string+'</div>';

  filterMap();
}

function removeFilter(filter_string) {
  var parent = document.getElementById('filter_list');
  var child = document.getElementById(filter_string);
  parent.removeChild(child);
  // make it remove filter from map
  
  var remove_relation = relationFinder(filter_string);
  var attribute = filter_string.slice(0,remove_relation[1]);
  var relation = remove_relation[0];
  var value = filter_string.slice(remove_relation[1]+1,filter_string.length);
  var array = [attribute,relation,value];
  for (i in current_filters) {
    if (current_filters[i][0] == attribute & current_filters[i][1] == relation & current_filters[i][2] == value) {
      var index = i;
      current_filters.splice(index,1);
    }
  }
  
  if (current_filters.length == 0) {
    document.getElementById('filter_filler').style.display = 'block';
  }
  filterMap();
}

function filterMap() {
  document.getElementById('popup').style.display = 'none';
  document.getElementById('popup-close').style.display = 'none';
  map.removeLayer(clusterGroup);
  map.removeLayer(heat);
  heat = L.heatLayer([]);
  // clusterGroup = new L.MarkerClusterGroup();
  clusterGroup.clearLayers();

  var timeline = {2005:0,2006:0,2007:0,2008:0,2009:0,2010:0,2011:0,2012:0,2013:0,2014:0,2015:0};
  var defect_count = 0;
  var mean_lifetime = 0;
  var lifetime_count = 0;
  var mean_tonnage = 0;
  var tonnage_count = 0;
  var defect_types = {};
  var track_types = {};
  var dvcd_types = {};
  var track_count = 0;
  var dvcd_count = 0;
  var cwr = 0;
  var bolted = 0;
  
  defects.eachLayer(function(layer) {
    if (filterLayer(layer,current_filters)) {
      heat.addLatLng(layer.getLatLng());
      clusterGroup.addLayer(layer);

      var foundDate = layer.feature.properties.FoundDate;
      var index = foundDate.lastIndexOf('/');
      var year = parseInt(foundDate.slice(index+1,foundDate.length));
      if (year < 2000) {
        year += 2000;
      }
      timeline[year] += 1;

      defect_count += 1;

      // var tonnage = parseInt(layer.feature.properties.Million)

      var lifetime = layer.feature.properties.RailAge;
      
      if (lifetime != '') {
        lifetime = parseInt(lifetime);
        mean_lifetime += lifetime;
        lifetime_count += 1;
      }

      var tonnage = layer.feature.properties['Million Gross Tons'];
      
      if (tonnage != '') {
        tonnage = parseInt(tonnage);
        mean_tonnage += tonnage;
        tonnage_count += 1;
      }

      var defect_type = layer.feature.properties.DefectType;
      if (defect_type in defect_types) {
        defect_types[defect_type] += 1;
      } else {
        defect_types[defect_type] = 1;
      }

      var track_type = layer.feature.properties.TrackType;
      if (track_type != '') {
        track_count += 1;
        if (track_type in track_types) {
          track_types[track_type] += 1;
        } else {
          track_types[track_type] = 1;
        }
      }
      

      var dvcd_type = layer.feature.properties.DvCd;
      if (dvcd_type != '') {
        dvcd_count += 1;
        if (dvcd_type in dvcd_types) {
          dvcd_types[dvcd_type] += 1;
        } else {
          dvcd_types[dvcd_type] = 1;
        }
      }

      var rail_type = layer.feature.properties['RailType'];
      if (rail_type == 'CWR') {
        cwr += 1;
      } else if (rail_type == 'BOLTED') {
        bolted += 1;
      }

    }
  });

  mean_lifetime = Math.round(100*mean_lifetime/(365*lifetime_count))/100;
  document.getElementById('mean-lifetime-value').innerHTML = mean_lifetime + ' Years';
  mean_tonnage = Math.round(100*mean_tonnage/tonnage_count)/100;
  document.getElementById('mean-tonnage-value').innerHTML = mean_tonnage + ' Million Gross Tons';
  document.getElementById('defect-count-value').innerHTML = defect_count + ' Defects';

  var first_defect = [0,''];
  var second_defect = [0,''];
  var third_defect = [0,''];
  for (defect in defect_types) {
    var count = defect_types[defect];
    if (count > first_defect[0]) {
      third_defect = second_defect;
      second_defect = first_defect;
      first_defect = [count,defect];
    } else if (count > second_defect[0]) {
      third_defect = second_defect;
      second_defect = [count,defect];
    } else if (count > third_defect[0]) {
      third_defect = [count,defect];
    }
  }
  first_defect[0] = Math.round(first_defect[0]*100/defect_count);
  second_defect[0] = Math.round(second_defect[0]*100/defect_count);
  third_defect[0] = Math.round(third_defect[0]*100/defect_count);

  document.getElementById('defect1').innerHTML = first_defect[1] + ' ' + first_defect[0] + '%';
  document.getElementById('defect2').innerHTML = second_defect[1] + ' ' + second_defect[0] +'%';
  document.getElementById('defect3').innerHTML = third_defect[1] + ' ' + third_defect[0] + '%';

  var first_track = [0,''];
  var second_track = [0,''];
  var third_track = [0,''];
  for (track in track_types) {
    var count = track_types[track];
    if (count > first_track[0]) {
      third_track = second_track;
      second_track = first_track;
      first_track = [count,track];
    } else if (count > second_track[0]) {
      third_track = second_track;
      second_track = [count,track];
    } else if (count > third_track[0]) {
      third_track = [count,track];
    }
  }
  first_track[0] = Math.round(first_track[0]*100/track_count);
  second_track[0] = Math.round(second_track[0]*100/track_count);
  third_track[0] = Math.round(third_track[0]*100/track_count);

  document.getElementById('track1').innerHTML = first_track[1] + ' ' + first_track[0] + '%';
  document.getElementById('track2').innerHTML = second_track[1] + ' ' + second_track[0] +'%';
  document.getElementById('track3').innerHTML = third_track[1] + ' ' + third_track[0] + '%';

  var first_dvcd = [0,''];
  var second_dvcd = [0,''];
  var third_dvcd = [0,''];
  for (dvcd in dvcd_types) {
    var count = dvcd_types[dvcd];
    if (count > first_dvcd[0]) {
      third_dvcd = second_dvcd;
      second_dvcd = first_dvcd;
      first_dvcd = [count,dvcd];
    } else if (count > second_dvcd[0]) {
      third_dvcd = second_dvcd;
      second_dvcd = [count,dvcd];
    } else if (count > third_dvcd[0]) {
      third_dvcd = [count,dvcd];
    }
  }
  first_dvcd[0] = Math.round(first_dvcd[0]*100/dvcd_count);
  second_dvcd[0] = Math.round(second_dvcd[0]*100/dvcd_count);
  third_dvcd[0] = Math.round(third_dvcd[0]*100/dvcd_count);

  document.getElementById('dvcd1').innerHTML = dvcd_dict[first_dvcd[1]] + ' ' + first_dvcd[0] + '%';
  document.getElementById('dvcd2').innerHTML = dvcd_dict[second_dvcd[1]] + ' ' + second_dvcd[0] +'%';
  document.getElementById('dvcd3').innerHTML = dvcd_dict[third_dvcd[1]] + ' ' + third_dvcd[0] + '%';

  var plate_count = cwr + bolted;
  cwr = Math.round(100*cwr/plate_count);
  bolted = Math.round(100*bolted/plate_count);
  document.getElementById('cwr').innerHTML = 'CWR ' + cwr + '%';
  document.getElementById('bolted').innerHTML = 'BOLTED ' + bolted + '%';


  var data = [];

  for (i in timeline){
    data.push([parseInt(i),timeline[i]]);
  }
  var options = {
    series: {
        lines: { show: true },
        points: { show: true }
    }
  };
  $(document).ready(function() {
    $.plot($('#time-series'), [data],options);
  });
    


  if (map.getZoom() > 13) {
    map.addLayer(clusterGroup);
  } else {
    map.addLayer(heat);
  }

}

function relationFinder(filterString) {
  if (filterString.indexOf('=') >= 0) {
    return ['=',filterString.indexOf('=')];
  } else if (filterString.indexOf('>') >= 0) {
    return ['>',filterString.indexOf('>')];
  } else if (filterString.indexOf('<') >= 0) {
    return ['<',filterString.indexOf('<')];
  }
}

function filterLayer(layer,filters) {
  // return true if feature passes through filter, false if feature should be removed.
  var filtered = false;
  for (filter in filters) {
    if (categorical_filters.indexOf(current_filters[filter][0]) >=0) {
      if (current_filters[filter][0] == 'Priority') {
        if (layer.feature.properties.Priority == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'DvCd') {
        if (layer.feature.properties.DvCd == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'TrackType') {
        if (layer.feature.properties.TrackType == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'Div') {
        if (layer.feature.properties.Div == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'LineName') {
        if (layer.feature.properties.LineName == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'Line') {
        if (layer.feature.properties.Line == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'Track') {
        if (layer.feature.properties.Track == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'DefectType') {
        if (layer.feature.properties.DefectType == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'PlateType') {
        if (layer.feature.properties.PlateType == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'RailWeight') {
        if (layer.feature.properties.RailWeight == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'RailType') {
        if (layer.feature.properties.RailType == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'Manufacturer') {
        if (layer.feature.properties.Manufacturer == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      } else if (current_filters[filter][0] == 'LineName') {
        if (layer.feature.properties.LineName == current_filters[filter][2]) {
          continue;
        } else {
          filtered = true;
          break;
        }
      }       
    } else if (numerical_filters.indexOf(current_filters[filter][0]) >=0) {
      if (current_filters[filter][0] == 'Million Gross Tons') {
        if (current_filters[filter][1] == '=') {
          if (parseFloat(layer.feature.properties['Million Gross Tons']) == parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '>') {
          if (parseFloat(layer.feature.properties['Million Gross Tons']) > parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '<') {
          if (parseFloat(layer.feature.properties['Million Gross Tons']) < parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        }        
      } else if (current_filters[filter][0] == 'RailAge') {
        if (current_filters[filter][1] == '=') {
          if (parseFloat(layer.feature.properties['RailAge'])/365 == parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '>') {
          if (parseFloat(layer.feature.properties['RailAge'])/365 > parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '<') {
          if (parseFloat(layer.feature.properties['RailAge'])/365 < parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        }        
      } else if (current_filters[filter][0] == 'latitude') {
        if (current_filters[filter][1] == '=') {
          if (parseFloat(layer.feature.geometry.coordinates[1]) == parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '>') {
          if (parseFloat(layer.feature.geometry.coordinates[1]) > parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '<') {
          if (parseFloat(layer.feature.geometry.coordinates[1]) < parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        }        
      } else if (current_filters[filter][0] == 'longitude') {
        if (current_filters[filter][1] == '=') {
          if (parseFloat(layer.feature.gemoetry.coordinates[0]) == parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '>') {
          if (parseFloat(layer.feature.geometry.coordinates[0]) > parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '<') {
          if (parseFloat(layer.feature.geometry.coordinates[0]) < parseFloat(current_filters[filter][2])) {
            continue;
          } else {
            filtered = true;
            break;
          }
        }        
      }
  
    } else if (date_filters.indexOf(current_filters[filter][0]) >=0) {
      if (current_filters[filter][0] == 'FoundDate') {
        var date = layer.feature.properties.FoundDate;
        var slash1 = date.indexOf('/');
        var slash2 = date.lastIndexOf('/');
        var month = parseInt(date.slice(0,slash1));
        var day = parseInt(date.slice(slash1+1,slash2));
        var year = parseInt(date.slice(slash2+1,date.length));
        if (year < 20) {
          year += 2000;
        } else if (year < 100) {
          year += 1900;
        }

        var filterDate = current_filters[filter][2];
        var dash1 = filterDate.indexOf('-');
        var dash2 = filterDate.lastIndexOf('-');
        var filterYear = parseInt(filterDate.slice(0,dash1));
        var filterMonth = parseInt(filterDate.slice(dash1+1,dash2));
        var filterDay = parseInt(filterDate.slice(dash2+1,filterDate.length));

        if (current_filters[filter][1] == '=') {
          if (year == filterYear & month == filterMonth & day == filterDay) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if(current_filters[filter][1] == '>') {
          if (year > filterYear) {
            continue;
          } else if (year < filterYear) {
            filtered = true;
            break;
          } else if (year == filterYear) {
            if (month > filterMonth) {
              continue;
            } else if (month < filterMonth) {
              filtered = true;
              break;
            } else if (month == filterMonth) {
              if (day > filterDay) {
                continue;
              } else {
                filtered = true;
                break;
              }
            }
          }
        } else if(current_filters[filter][1] == '<') {
          if (year < filterYear) {
            continue;
          } else if (year > filterYear) {
            filtered = true;
            break;
          } else if (year == filterYear) {
            if (month < filterMonth) {
              continue;
            } else if (month > filterMonth) {
              filtered = true;
              break;
            } else if (month == filterMonth) {
              if (day < filterDay) {
                continue;
              } else {
                filtered = true;
                break;
              }
            }
          }
        }
      } else if (current_filters[filter][0] == 'ProducedDate') {
        var date = parseInt(layer.feature.properties.ProducedDate);
        if (date < 20) {
          date += 2000;
        } else if (date < 100) {
          date += 1900;
        } 

        var filterDate = current_filters[filter][2];
        var dash1 = filterDate.indexOf('-');
        var dash2 = filterDate.lastIndexOf('-');
        var filterYear = parseInt(filterDate.slice(0,dash1));
        var filterMonth = parseInt(filterDate.slice(dash1+1,dash2));
        var filterDay = parseInt(filterDate.slice(dash2+1,filterDate.length));

        if (current_filters[filter][1] == '=') {
          if (date == filterYear) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '>') {
          if (date > filterYear) {
            continue;
          } else {
            filtered = true;
            break;
          }
        } else if (current_filters[filter][1] == '<') {
          if (date < filterYear) {
            continue;
          } else {
            filtered = true;
            break;
          }
        }
      }
    }
  }
  return !filtered;
}


</script>
</body>
</html>
